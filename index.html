<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Turnero De Ultima Milla</title>

  <!-- ‚úÖ PWA: MANIFEST + COLOR (AJUSTADO PARA GITHUB PAGES /Ruteoweb/) -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#3933EB">

  <!-- ‚úÖ PWA (iOS): ICONO + MODO APP (AJUSTADO PARA GITHUB PAGES /Ruteoweb/) -->
  <link rel="apple-touch-icon" href="./img/logo.jpeg">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <!-- FAVICON -->
  <link rel="icon" type="image/jpeg" href="img/logo.jpeg">

  <!-- ESTILOS -->
  <link rel="stylesheet" href="assets/css/main.css">
</head>

<body>

  <!-- ================= HEADER ================= -->
  <header class="topbar">
    <div class="logo" style="display:flex;align-items:center;gap:10px;">
      <img src="img/logo.jpeg" alt="Logo Despachos" style="height:32px;width:auto;">
      üöö Despachos
    </div>
    <div class="icons">üîî ‚úâÔ∏è ‚öôÔ∏è</div>
  </header>

  <!-- ‚úÖ PWA: MODAL INSTALAR (NUEVO) -->
  <div id="pwa-install-modal" style="display:none;" aria-hidden="true">
    <div class="pwa-modal-backdrop"></div>

    <div class="pwa-modal" role="dialog" aria-modal="true" aria-labelledby="pwa-title">
      <h3 id="pwa-title" class="pwa-title">Instal√° la app</h3>

      <p class="pwa-desc">
        Instal√° la app para entrar m√°s r√°pido y recibir avisos importantes.
      </p>

      <!-- ‚úÖ Instrucciones iPhone (se muestran solo en iOS) -->
      <div id="pwa-ios-steps" class="pwa-ios-steps" style="display:none;">
        <ol style="margin:10px 0 0; padding-left:18px;">
          <li>Toc√° <strong>Compartir</strong> (cuadradito con flecha ‚Üë).</li>
          <li>Eleg√≠ <strong>‚ÄúAgregar a pantalla de inicio‚Äù</strong>.</li>
          <li>Confirm√° con <strong>‚ÄúAgregar‚Äù</strong>.</li>
        </ol>
        <p style="margin:10px 0 0; font-size:12px; color:#64748b;">
          Luego abr√≠ la app desde el √≠cono.
        </p>
      </div>

      <div class="pwa-actions">
        <button id="pwa-btn-later" type="button" class="pwa-btn pwa-btn-secondary">Ahora no</button>

        <!-- Android -->
        <button id="pwa-btn-install" type="button" class="pwa-btn pwa-btn-primary" disabled>Instalar</button>

        <!-- iPhone -->
        <button id="pwa-btn-how" type="button" class="pwa-btn pwa-btn-primary" style="display:none;">C√≥mo instalar</button>
      </div>
    </div>
  </div>

  <!-- ================= FICHAJE CHOFER ================= -->
  <main class="wrapper">

    <!-- ‚úÖ NUEVO CONTENEDOR PARA LAYOUT PRO (NO ROMPE NADA) -->
    <div class="driver-layout">

      <!-- ‚úÖ TU CARD IGUAL -->
      <div class="card">

        <!-- ‚úÖ NUEVO: BANNER ARRIBA (HORA CITADA + ESTADO) - arranca oculto -->
        <!-- driver.js lo va a completar (hora, estado, diferencia) -->
        <div
          id="cita-banner"
          class="cita-banner"
          style="display:none;"
          role="status"
          aria-live="polite"
        >
          <div class="cita-banner__top">
            <span class="cita-badge" id="cita-badge">‚è±Ô∏è</span>
            <span class="cita-title" id="cita-title">Hora citada</span>
            <span class="cita-hour" id="cita-hour">--:--</span>
          </div>

          <div class="cita-banner__bottom">
            <span class="cita-state" id="cita-state">‚Äî</span>
            <span class="cita-delta" id="cita-delta"></span>
          </div>
        </div>

        <h1 id="welcome">Bienvenido</h1>

        <p class="subtitle">
          Toc√° el bot√≥n para registrar tu llegada al centro de despacho.
        </p>

        <!-- ‚úÖ SELECTOR DE CHOFER -->
        <div style="text-align:left;margin:14px 0 18px;">
          <label for="driverSelect" style="font-weight:700;color:#0f172a;display:block;margin-bottom:6px;">
            Seleccion√° tu nombre
          </label>

          <select id="driverSelect" style="width:100%;padding:12px;border-radius:12px;border:1px solid #e5e7eb;">
            <option value="">Cargando...</option>
          </select>

          <p id="turnoInfo" style="margin:10px 0 0;font-size:13px;color:#475569;"></p>
        </div>

        <button id="btnFichar" class="primary-btn">
          Registrar llegada
        </button>

        <div id="loader" class="loader hidden">
          ‚è≥ Esperando confirmaci√≥n de llegada...
        </div>

        <!-- ‚úÖ NUEVO: MI HORARIO (PERSONAL - solo para ese chofer) -->
        <!-- (NO BORRO NADA: lo dejamos por compatibilidad; si despu√©s no lo usamos, queda oculto) -->
        <div id="mi-horario-box" style="display:none;margin-top:10px;text-align:left;"></div>

        <!-- ‚úÖ NUEVO: BOT√ìN QR PLEGABLE (arranca oculto; driver.js lo muestra cuando corresponda) -->
        <button
          id="btnToggleQR"
          type="button"
          style="display:none;margin-top:12px;width:100%;border:1px solid #e5e7eb;background:#fff;border-radius:12px;padding:12px;font-weight:800;cursor:pointer;">
          Mostrar QR
        </button>

        <!-- ‚úÖ CONTENEDOR QR (AHORA PLEGABLE: arranca oculto) -->
        <div id="qr-container" style="margin-top:14px;text-align:center;display:none;"></div>

        <div class="divider"></div>

        <div class="section">
          <h3>Ubicaci√≥n</h3>
          <p>
            Centro de Despacho BIDCOM, Estomba 522, Buenos Aires.
          </p>
        </div>

      </div>

      <!-- ‚úÖ AHORA EL ESTADO DEL D√çA VA AL COSTADO (desktop) -->
      <div id="hoy-box" class="hoy-side" style="display:none;">
        <h3 style="margin:0 0 10px;color:#0f172a;">üìã Estado del d√≠a</h3>

        <div id="hoy-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
          <div style="background:#fff7ed;border:1px solid #fed7aa;border-radius:14px;padding:12px;">
            <div style="font-weight:900;color:#9a3412;margin-bottom:8px;">üü° Pendientes</div>
            <ul id="lista-pendientes-chofer" style="list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:10px;"></ul>
          </div>

          <div style="background:#ecfdf5;border:1px solid #bbf7d0;border-radius:14px;padding:12px;">
            <div style="font-weight:900;color:#166534;margin-bottom:8px;">üü¢ Despachados</div>
            <ul id="lista-despachados-chofer" style="list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:10px;"></ul>
          </div>
        </div>

        <p style="margin:10px 0 0;font-size:12px;color:#64748b;">
          Ordenado por hora de llegada.
        </p>
      </div>

    </div>
  </main>

  <!-- ================= PANEL OPERATIVO ================= -->
  <section id="panel" class="panel-wrapper">

    <h2 class="panel-title">Panel del d√≠a</h2>

    <div class="panel-layout">

      <div class="panel-main">

        <div id="qr-despacho" style="margin:20px 0; display:none;">
          <h3>üì∑ Escanear QR para despachar</h3>
          <div id="qr-reader" style="max-width:320px"></div>
          <p id="qr-resultado" style="font-weight:bold;margin-top:10px;"></p>
        </div>

        <div class="panel-tablas">

          <div class="panel-col">
            <h3>üü° Pendientes</h3>
            <ul id="lista-pendientes" class="lista"></ul>
          </div>

          <div class="panel-col">
            <h3>üü¢ Despachados</h3>
            <ul id="lista-despachados" class="lista"></ul>
          </div>

        </div>
      </div>

      <aside class="panel-side">
        <div class="panel-resumen">

          <div class="resumen-item">
            <span class="resumen-label">Choferes activos</span>
            <span id="total-activos" class="resumen-value">0</span>
          </div>

          <div class="resumen-item">
            <span class="resumen-label">Pendientes</span>
            <span id="total-pendientes" class="resumen-value">0</span>
          </div>

          <div class="resumen-item">
            <span class="resumen-label">Despachados</span>
            <span id="total-despachados" class="resumen-value">0</span>
          </div>

        </div>
      </aside>

    </div>

    <div class="panel-signature">
      <strong>JUCA¬Æ</strong>
    </div>

  </section>

  <!-- ‚úÖ ESTILO SOLO PARA EL LAYOUT (despu√©s lo pasamos a main.css) -->
  <style>
    .driver-layout{
      width: 100%;
      max-width: 980px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 420px 1fr;
      gap: 18px;
      align-items: start;
    }

    .hoy-side{
      background: white;
      border-radius: 18px;
      padding: 18px;
      box-shadow: 0 40px 80px rgba(0,0,0,0.20);
    }

    /* ‚úÖ NUEVO (NO ROMPE): banner compacto arriba del card */
    .cita-banner{
      width: 100%;
      border-radius: 14px;
      padding: 10px 12px;
      margin-bottom: 12px;
      background: #fff7ed;
      border: 1px solid #fed7aa;
      text-align: left;
    }
    .cita-banner__top{
      display:flex;
      align-items:center;
      gap:10px;
      justify-content: space-between;
    }
    .cita-badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width: 34px;
      height: 34px;
      border-radius: 10px;
      background:#ffedd5;
      border:1px solid #f59e0b;
      font-weight:900;
    }
    .cita-title{
      flex: 1;
      font-weight: 900;
      color:#9a3412;
      font-size: 13px;
      letter-spacing: .02em;
    }
    .cita-hour{
      font-weight: 950;
      color:#0f172a;
      font-size: 14px;
      padding: 6px 10px;
      border-radius: 999px;
      background:#ffffff;
      border:1px solid #e5e7eb;
      white-space:nowrap;
    }
    .cita-banner__bottom{
      display:flex;
      gap:8px;
      margin-top: 6px;
      font-size: 12px;
      color:#475569;
      font-weight: 700;
    }
    .cita-state{
      color:#0f172a;
      font-weight: 900;
    }
    .cita-delta{
      color:#475569;
      font-weight: 800;
    }

    @media (max-width: 1024px){
      .driver-layout{
        grid-template-columns: 1fr;
      }
      #hoy-grid{
        grid-template-columns: 1fr !important;
      }
    }
  </style>

  <!-- ================= SCRIPTS ================= -->
  <script type="module" src="assets/js/driver.js"></script>
  <script type="module" src="assets/js/panel.js"></script>

  <!-- ‚úÖ PWA: REGISTRO SERVICE WORKER (AJUSTADO PARA GITHUB PAGES /Ruteoweb/) -->
  <script>
    (function () {
      if (!("serviceWorker" in navigator)) return;

      window.addEventListener("load", function () {
        navigator.serviceWorker.register("./service-worker.js")
          .then(function () {
            // ok
          })
          .catch(function (err) {
            console.warn("Service Worker no se pudo registrar:", err);
          });
      });
    })();
  </script>

  <!-- ‚úÖ PWA: MODAL INSTALAR (AL ENTRAR) - ANDROID PROMPT / iPHONE INSTRUCCIONES -->
  <script>
    (function () {
      const params = new URLSearchParams(window.location.search);
      if (params.get("panel") === "1") return; // no molestar al panel

      const modal = document.getElementById("pwa-install-modal");
      const btnLater = document.getElementById("pwa-btn-later");
      const btnInstall = document.getElementById("pwa-btn-install");
      const btnHow = document.getElementById("pwa-btn-how");
      const iosSteps = document.getElementById("pwa-ios-steps");

      if (!modal || !btnLater || !btnInstall || !btnHow) return;

      function isInstalled() {
        const standaloneMatch = window.matchMedia && window.matchMedia("(display-mode: standalone)").matches;
        const iosStandalone = ("standalone" in navigator) && navigator.standalone === true;
        return !!(standaloneMatch || iosStandalone);
      }

      function isIOS() {
        return /iphone|ipad|ipod/i.test(navigator.userAgent);
      }

      function isAndroid() {
        return /android/i.test(navigator.userAgent);
      }

      function showModal() {
        modal.style.display = "block";
        modal.setAttribute("aria-hidden", "false");
      }

      function hideModal() {
        modal.style.display = "none";
        modal.setAttribute("aria-hidden", "true");
      }

      // Si ya est√° instalada, no mostramos nada
      if (isInstalled()) return;

      // iPhone: mostramos modal + bot√≥n "C√≥mo instalar"
      if (isIOS()) {
        btnInstall.style.display = "none";
        btnHow.style.display = "inline-block";
        if (iosSteps) iosSteps.style.display = "none"; // se muestra al tocar "C√≥mo instalar"
        showModal();

        btnHow.addEventListener("click", function () {
          if (iosSteps) iosSteps.style.display = "block";
        });

        btnLater.addEventListener("click", hideModal);
        modal.querySelector(".pwa-modal-backdrop").addEventListener("click", hideModal);
        return;
      }

      // Android: mostramos modal al entrar, y habilitamos el prompt cuando el navegador lo permita
      if (isAndroid()) {
        let deferredPrompt = null;

        // Modal visible al entrar
        btnHow.style.display = "none";
        btnInstall.style.display = "inline-block";
        btnInstall.disabled = true;
        showModal();

        // Capturar evento instalable
        window.addEventListener("beforeinstallprompt", function (e) {
          e.preventDefault();
          deferredPrompt = e;
          btnInstall.disabled = false;
        });

        btnInstall.addEventListener("click", async function () {
          if (!deferredPrompt) return;
          deferredPrompt.prompt();
          try {
            await deferredPrompt.userChoice;
          } catch (_) {}
          deferredPrompt = null;
          hideModal();
        });

        btnLater.addEventListener("click", hideModal);
        modal.querySelector(".pwa-modal-backdrop").addEventListener("click", hideModal);
        return;
      }

      // Otros (desktop, etc): no mostramos modal para no molestar
      // (si quer√©s que tambi√©n aparezca en desktop, lo activamos despu√©s)
    })();
  </script>

</body>
</html>
